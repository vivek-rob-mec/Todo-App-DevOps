# roles/ec2_launch/tasks/main.yml
---

- name: Add security group for EC2 instance
  amazon.aws.ec2_group:
    name: vivek-security
    description: Security group for SSH and app access
    region: "{{ aws_region }}"
    rules:
      - proto: tcp
        from_port: 22
        to_port: 22
        cidr_ip: 0.0.0.0/0
      - proto: tcp
        from_port: 3000
        to_port: 3001
        cidr_ip: 0.0.0.0/0
      - proto: tcp
        from_port: 88
        to_port: 88
        cidr_ip: 0.0.0.0/0
    rules_egress:
      - proto: all
        cidr_ip: 0.0.0.0/0
  register: security_group

- name: Launch EC2 instance
  amazon.aws.ec2_instance:
    name: Ansible-created-instances
    key_name: {{ ec2_key_name }}
    region: {{ aws_region }}
    instance_type: {{ ec2_instance_type }}
    image_id: {{ ec2_ami_id }}
    wait: yes
    count: 1
    network:
      assign_public_ip: true
    security_group_id: {{ security_group.group_id }}
  register: ec2

- name: Debug EC2 launch result
  debug:
    var: ec2
